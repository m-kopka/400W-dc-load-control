#include "internal_isen.h"
#include "hal/adc.h"

//---- PRIVATE DATA ----------------------------------------------------------------------------------------------------------------------------------------------

// lookup table for conversion from raw 8bit adc value to current in mA
const uint16_t internal_isen_lut[256] = {

        0,     0,    89,   134,   179,   224,   268,   313,   358,   403,   447,   492,   537,   582,   626,   671,
      716,   760,   805,   850,   895,   939,   984,  1029,  1074,  1118,  1163,  1208,  1253,  1297,  1342,  1387,
     1432,  1476,  1521,  1566,  1610,  1655,  1700,  1745,  1789,  1834,  1879,  1924,  1968,  2013,  2058,  2103,
     2147,  2192,  2237,  2281,  2326,  2371,  2416,  2460,  2505,  2550,  2595,  2639,  2684,  2729,  2774,  2818, 
     2863,  2908,  2953,  2997,  3042,  3087,  3131,  3176,  3221,  3266,  3310,  3355,  3400,  3445,  3489,  3534,
     3579,  3624,  3668,  3713,  3758,  3802,  3847,  3892,  3937,  3981,  4026,  4071,  4116,  4160,  4205,  4250,
     4295,  4339,  4384,  4429,  4473,  4518,  4563,  4608,  4652,  4697,  4742,  4787,  4831,  4876,  4921,  4966,
     5010,  5055,  5100,  5145,  5189,  5234,  5279,  5323,  5368,  5413,  5458,  5502,  5547,  5592,  5637,  5681,
     5726,  5771,  5816,  5860,  5905,  5950,  5994,  6039,  6084,  6129,  6173,  6218,  6263,  6308,  6352,  6397,
     6442,  6487,  6531,  6576,  6621,  6666,  6710,  6755,  6800,  6844,  6889,  6934,  6979,  7023,  7068,  7113,
     7158,  7202,  7247,  7292,  7337,  7381,  7426,  7471,  7515,  7560,  7605,  7650,  7694,  7739,  7784,  7829,
     7873,  7918,  7963,  8008,  8052,  8097,  8142,  8186,  8231,  8276,  8321,  8365,  8410,  8455,  8500,  8544,
     8589,  8634,  8679,  8723,  8768,  8813,  8858,  8902,  8947,  8992,  9036,  9081,  9126,  9171,  9215,  9260,   
     9305,  9350,  9394,  9439,  9484,  9529,  9573,  9618,  9663,  9707,  9752,  9797,  9842,  9886,  9931,  9976,
    10021, 10065, 10110, 10155, 10200, 10244, 10289, 10334, 10379, 10423, 10468, 10513, 10557, 10602, 10647, 10692,
    10736, 10781, 10826, 10871, 10915, 10960, 11005, 11050, 11094, 11139, 11184, 11228, 11273, 11318, 11363, 11407
};

//---- INTERNAL FUNCTIONS ----------------------------------------------------------------------------------------------------------------------------------------

static inline uint8_t get_adc_chan(internal_isen_t current_sink) {

         if (current_sink == CURRENT_L1) return (I_SEN_L1_ADC_CH);
    else if (current_sink == CURRENT_L2) return (I_SEN_L2_ADC_CH);
    else if (current_sink == CURRENT_R1) return (I_SEN_R1_ADC_CH);
    else                                 return (I_SEN_R2_ADC_CH);
}

//---- FUNCTIONS -------------------------------------------------------------------------------------------------------------------------------------------------

// initializes the ADC for internal current sensing
void internal_isen_init(void) {

    rcc_enable_peripheral_clock(I_SEN_L1_GPIO_CLOCK);
    rcc_enable_peripheral_clock(I_SEN_L2_GPIO_CLOCK);
    rcc_enable_peripheral_clock(I_SEN_R1_GPIO_CLOCK);
    rcc_enable_peripheral_clock(I_SEN_R2_GPIO_CLOCK);
    gpio_set_mode(I_SEN_L1_GPIO, GPIO_MODE_ANALOG);
    gpio_set_mode(I_SEN_L2_GPIO, GPIO_MODE_ANALOG);
    gpio_set_mode(I_SEN_R1_GPIO, GPIO_MODE_ANALOG);
    gpio_set_mode(I_SEN_R2_GPIO, GPIO_MODE_ANALOG);
}

//- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 

// measures current of a individual current sink [mA]
uint16_t internal_isen_read(internal_isen_t current_sink) {

    if (current_sink != CURRENT_L1 && current_sink != CURRENT_L2 && current_sink != CURRENT_R1 && current_sink != CURRENT_R2) return 0;

    return internal_isen_lut[adc_read(get_adc_chan(current_sink)) >> 4];
}

//----------------------------------------------------------------------------------------------------------------------------------------------------------------
